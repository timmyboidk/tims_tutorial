import type { Lesson } from '../types';

export const backendM1M3: Lesson[] = [
    {
        id: 'be-1-1', type: 'backend',
        title: 'è¯¾ç¨‹ 1.1ï¼šSpring Boot SaaS åŸºç¡€è®¾æ–½',
        category: 'æ¨¡å—1ï¼šSpring Boot æ ¸å¿ƒä¸æ•°æ®åº“', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 1, lessonNumber: 1, language: 'java',
        startingCode: '',
        instructions: `# æ­å»ºçŸ­è§†é¢‘ SaaS åç«¯æ¶æ„\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nçŸ­è§†é¢‘å¹³å°é¢ä¸´çš„æµ·é‡é«˜å¹¶å‘è¯·æ±‚ï¼Œéœ€è¦åç«¯çš„ç»å¯¹ç¨³å®šä¸é«˜æ€§èƒ½ã€‚æˆ‘ä»¬æŠ›å»è‡ƒè‚¿çš„æ¡†æ¶ï¼Œç›´æ¥åŸºäº Spring Boot 3 é…åˆæç®€çš„çº¦å®šä¼˜äºé…ç½®ï¼ˆConvention over Configurationï¼‰æ¥æ­å»ºè„šæ‰‹æ¶ã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- æŒæ¡ Spring IoCï¼ˆæ§åˆ¶åè½¬ï¼‰ä¸ DIï¼ˆä¾èµ–æ³¨å…¥ï¼‰è§£å†³å¼ºè€¦åˆçš„æŠ€æœ¯ã€‚\n- ç†è§£åº”ç”¨å¯åŠ¨çš„ä¸»è„‰ç»œã€‚`,
        targetCode: `package com.codeforge.video;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n// ğŸ’¡ @SpringBootApplication æ˜¯ä¸ªç»„åˆæ³¨è§£ï¼Œ\n// å†…å«è‡ªåŠ¨é…ç½®ã€ç»„ä»¶æ‰«æã€é…ç½®ç±»æ ‡å¿—ä¸‰åˆä¸€åŠŸèƒ½\n@SpringBootApplication\n@RestController\npublic class VideoSaaSApplication {\n\n    public static void main(String[] args) {\n        // ğŸ’¡ å¯åŠ¨å†…åµŒçš„ Tomcat æœåŠ¡å™¨\n        SpringApplication.run(VideoSaaSApplication.class, args);\n    }\n\n    @GetMapping("/api/health")\n    public String healthCheck() {\n        // ğŸ’¡ è¿ç»´ç›‘æ§æŒ‡æ ‡ï¼šç”¨äº K8s ç­‰ç¯å¢ƒæ¢æµ‹å®¹å™¨æ˜¯å¦å­˜æ´»\n        return "Video SaaS Backend is Running";\n    }\n}\n`,
        comments: [
            { line: 9, text: '// ğŸ’¡ æç®€çš„å¯åŠ¨ç±»ï¼Œä¹Ÿæ˜¯é…ç½®ç±»çš„æºå¤´' },
            { line: 15, text: '// ğŸ’¡ æ‘†è„±ä¼ ç»Ÿ XML ç¹çé…ç½®çš„é­”æ³•æ¥æº' },
            { line: 20, text: '// ğŸ’¡ SaaS å¿…å¤‡ï¼šLiveness Probe å­˜æ´»æ¢é’ˆ' },
        ],
        diagramMarkup: `sequenceDiagram\n    participant DevOps as K8s è°ƒåº¦ç³»ç»Ÿ\n    participant App as Spring Boot å®¹å™¨\n    DevOps->>App: GET /api/health\n    App-->>DevOps: 200 OK (Running)\n    Note over DevOps,App: å¦‚æœè¿”å›å¤±è´¥ï¼Œå®¹å™¨å°†è¢«æ— æƒ…é‡å¯`,
    },
    {
        id: 'be-1-2', type: 'backend',
        title: 'è¯¾ç¨‹ 1.2ï¼šMyBatis æŸ¥è¯¢è§†é¢‘ä¿¡æ¯æµ',
        category: 'æ¨¡å—1ï¼šSpring Boot æ ¸å¿ƒä¸æ•°æ®åº“', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 1, lessonNumber: 2, language: 'java',
        startingCode: '',
        instructions: `# ä½¿ç”¨ MyBatis é©±åŠ¨æ•°æ®æº\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nåœ¨å‰ç«¯çš„ \`InfiniteSaaSFeed\` ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹å‘è§†é¢‘åˆ—è¡¨ã€‚åœ¨ Java ç”Ÿæ€é‡Œï¼Œç›¸è¾ƒäº Hibernate é»‘ç›’èˆ¬çš„ç¬¨é‡ï¼ŒMyBatis æä¾›äº† SQL çš„ç»å¯¹è°ƒä¼˜æ§åˆ¶æƒã€‚åƒä¸‡çº§çš„ MySQL è§†é¢‘è¡¨ï¼Œç»ä¸å®¹å¿å…¨è¡¨æ‰«æçš„æ…¢ SQLã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- ä½¿ç”¨ \`@Mapper\` æ˜ å°„æ¥å£ä¸ SQLã€‚\n- \`@Select\` æ³¨è§£ä¸åˆ†é¡µæŸ¥è¯¢ã€‚`,
        targetCode: `package com.codeforge.video.mapper;\n\nimport org.apache.ibatis.annotations.Mapper;\nimport org.apache.ibatis.annotations.Select;\nimport org.apache.ibatis.annotations.Param;\nimport java.util.List;\n\n// ğŸ’¡ é¢†åŸŸæ¨¡å‹ (Entity)\npublic class VideoEntity {\n    public Long id;\n    public String title;\n    public String author;\n    public Integer views;\n    public String thumbnail;\n}\n\n// ğŸ’¡ æ¥å£å³å®ç°ï¼šMyBatis åŠ¨æ€ä»£ç†æœºåˆ¶ä¸ºä½ ç”Ÿæˆäº†å®ç°ç±»\n@Mapper\npublic interface VideoMapper {\n    \n    // ğŸ’¡ çŸ­è§†é¢‘æ ¸å¿ƒ SQLï¼šåˆ†é¡µä¸‹æ¨åˆ°æ•°æ®åº“å±‚é¢è¿›è¡Œ LIMIT/OFFSET\n    @Select("SELECT id, title, author, views, thumbnail FROM videos "\n          + "ORDER BY created_at DESC LIMIT #{limit} OFFSET #{offset}")\n    List<VideoEntity> fetchVideoFeed(\n        @Param("offset") int offset, \n        @Param("limit") int limit\n    );\n}\n`,
        comments: [
            { line: 17, text: '// ğŸ’¡ äº¤ç»™ Spring IoC å®¹å™¨å»ç®¡ç†çš„ Mapper' },
            { line: 21, text: '// ğŸ’¡ #{...} æ˜¯é¢„ç¼–è¯‘å‚æ•°ï¼Œç»å¯¹é˜²å¾¡ SQL æ³¨å…¥æ”»å‡»' },
            { line: 24, text: '// ğŸ’¡ @Param ç»‘å®šå‚æ•°ï¼Œä½¿å¾— SQL å¯ä»¥æ ¹æ®åå­—æŠ½å–å€¼' },
        ],
        diagramMarkup: `sequenceDiagram\n    participant Client as å®¢æˆ·ç«¯\n    participant Controller as Videos API\n    participant Base as MyBatis ä»£ç†\n    participant DB as MySQL ä¸»åº“\n    \n    Client->>Controller: GET /api/videos?page=2\n    Controller->>Base: è½¬æ¢ä¸º offset=20, limit=20\n    Base->>DB: å‘é€å¸¦åˆ†é¡µçš„é¢„ç¼–è¯‘ SQL æŸ¥è¯¢\n    DB-->>Base: æå–è¿”å›çš„ 20 è¡Œ\n    Base-->>Controller: æ˜ å°„è‡³ List<VideoEntity>\n    Controller-->>Client: è½¬æ¢ä¸º JSON æ•°ç»„`,
    },
    {
        id: 'be-1-3', type: 'backend',
        title: 'è¯¾ç¨‹ 1.3ï¼šGraalVM æ„å»ºæ¯«ç§’å¯åŠ¨çš„ Native API',
        category: 'æ¨¡å—1ï¼šSpring Boot æ ¸å¿ƒä¸æ•°æ®åº“', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 1, lessonNumber: 3, language: 'java',
        startingCode: '',
        instructions: `# æŠ›å¼ƒ JVMï¼šGraalVM Ahead-Of-Time ç¼–è¯‘\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nåœ¨åŒåä¸€ç­‰çªå‘æµé‡é«˜å³°ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ K8s HPA è‡ªåŠ¨æ‰©å®¹åç«¯èŠ‚ç‚¹ï¼ŒJVM çš„é•¿æ—¶é—´é¢„çƒ­ä¼šå¯¼è‡´æµé‡è¿›æ¥çš„å‰ 30 ç§’å…¨éƒ¨è¶…æ—¶ã€‚GraalVM å°† Java ä»£ç  AOT (Ahead-of-Time) ç¼–è¯‘æˆäº†å’Œ C++ ä¸€æ ·ç›´æ¥è·‘åœ¨æ“ä½œç³»ç»Ÿä¸Šçš„äºŒè¿›åˆ¶æœºå™¨ç ï¼Œå†·å¯åŠ¨ä» 3 ç§’ç¬é—´é™è‡³ 0.05 ç§’ã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- äº†è§£ native-image æ¦‚å¿µå’Œ Spring Boot 3 AOT å¤„ç†ã€‚\n- ç¼–å†™é…ç½®ï¼Œä½¿å…¶å…¼å®¹åå°„æ”¯æŒã€‚`,
        targetCode: `// ğŸ’¡ åœ¨ build.gradle ä¸­é…ç½® GraalVM Native Image æ„å»º\nplugins {\n    id 'java'\n    id 'org.springframework.boot' version '3.2.0'\n    // ğŸ’¡ å¼•å…¥ Spring Boot çš„ Native æ„å»ºæ’ä»¶\n    id 'org.graalvm.buildtools.native' version '0.9.28'\n}\n\ngraalvmNative {\n    binaries {\n        main {\n            // ğŸ’¡ é•œåƒåç§°\n            imageName = 'video-saas-api'\n            // ğŸ’¡ å¼€å¯å¿«é€Ÿæ„å»ºæ¨¡å¼ï¼Œç‰ºç‰²éƒ¨åˆ†ä¼˜åŒ–æ¢å–æ„å»ºæ—¶é—´\n            buildArgs.add('-O1')\n            // ğŸ’¡ æŒ‡å®šåœ¨å®¹å™¨åŒ–éƒ¨ç½²æ—¶çš„è¿è¡Œç¯å¢ƒï¼Œæ¯”å¦‚åªç”¨æå°çš„ alpine ç¯å¢ƒ\n            buildArgs.add('--static')\n        }\n    }\n}\n\n// ğŸ’¡ ç»ˆç«¯ä¸‹æ‰§è¡Œå‘½ä»¤çš„å¹½çµæç¤ºï¼š\n// $ ./gradlew nativeCompile\n// $ ./build/native/nativeCompile/video-saas-api\n`,
        comments: [
            { line: 6, text: '// ğŸ’¡ è¿™æ˜¯ Spring Boot 3 æ”¾å‡ºçš„æ€§èƒ½å¤§æ‹›' },
            { line: 11, text: '// ğŸ’¡ æŒ‡å¯¼ C++ ç¼–è¯‘å™¨å¦‚ä½•ç”Ÿæˆæœºå™¨ç ' },
            { line: 22, text: '// ğŸ’¡ ç”Ÿæˆå‡ºæ¥çš„æ–‡ä»¶ä¸å†éœ€è¦ java -jar è¿è¡Œï¼Œå®ƒå°±æ˜¯æ“ä½œç³»ç»Ÿçš„å¯æ‰§è¡Œæ–‡ä»¶' },
        ],
    },
    {
        id: 'be-2-1', type: 'backend',
        title: 'è¯¾ç¨‹ 2.1ï¼šåˆ©ç”¨ JWT ä¿æŠ¤ç‚¹èµç³»ç»Ÿçš„æ— çŠ¶æ€æ¶æ„',
        category: 'æ¨¡å—2ï¼šè®¤è¯ä¸ç¼“å­˜ä¸­é—´ä»¶', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 2, lessonNumber: 1, language: 'java',
        startingCode: '',
        instructions: `# æ— çŠ¶æ€å®‰å…¨ JWT å®æˆ˜\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nä¸Šä¸€æ¨¡å—å®Œæˆäº†å‰ç«¯çš„ \`LoginForm\`ã€‚ä¸ºäº†åº”å¯¹ä¸Šäº¿ç”¨æˆ·ï¼Œä½ çš„åç«¯å¿…é¡»æ˜¯æ°´å¹³æ‰©å®¹ï¼ˆHorizontal Scalingï¼‰çš„ã€‚å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„ Session å­˜åœ¨å†…å­˜é‡Œï¼Œç¬¬ä¸€å°æœºå™¨ç™»å½•çš„ç”¨æˆ·åˆ°äº†ç¬¬äºŒå°æœºå™¨å°±ä¼šæ‰çº¿ã€‚\nJSON Web Token (JWT) æ˜¯å¤©ç”Ÿé€‚é…å¾®æœåŠ¡çš„**æ— çŠ¶æ€ï¼ˆStatelessï¼‰**é‰´æƒæ–¹æ¡ˆï¼šæ‰€æœ‰ç”¨æˆ·èº«ä»½å…¨éƒ¨å†™åœ¨ä»¤ç‰Œé‡Œï¼Œå¹¶ä½¿ç”¨ HMAC ç­¾åé˜²æ­¢ä¼ªé€ ã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- éªŒè¯ JWT çš„æœ‰æ•ˆæ€§ã€‚\n- ä»ä¸­æå–ç”¨æˆ·è§’è‰²ï¼Œå¹¶é˜²èŒƒè¿‡æœŸä¸ä¸²æ”¹ã€‚`,
        targetCode: `package com.codeforge.security;\n\nimport io.jsonwebtoken.Jwts;\nimport io.jsonwebtoken.security.Keys;\nimport org.springframework.stereotype.Service;\nimport java.util.Date;\n\n@Service\npublic class JwtTokenManager {\n    // ğŸ’¡ æ°¸è¿œä¸è¦ç¡¬ç¼–ç ï¼è¿™åº”å½“ä» application.yml ä¸­æ³¨å…¥\n    private final String secretKey = "a_very_complex_secret_key_used_for_hmac_sha256";\n\n    // ğŸ’¡ JWT æ˜¯è‡ªåŒ…å«çš„é€šè¡Œè¯ï¼Œåªè¦ä¸æ¼æ³„ secretKeyï¼Œæ— äººèƒ½ä¼ªé€ \n    public boolean validateToken(String token) {\n        try {\n            Jwts.parser()\n                // ğŸ’¡ åœ¨æ­¤æŠŠç§˜é’¥å–‚ç»™è§£æå™¨ï¼Œå®ƒä¼šé‡æ–°ç®—ä¸€éç­¾åæ˜¯å¦ä¸€è‡´\n                .verifyWith(Keys.hmacShaKeyFor(secretKey.getBytes()))\n                .build()\n                .parseSignedClaims(token);\n            return true;\n        } catch (Exception e) {\n            // ğŸ’¡ è¿‡æœŸ(Expired)ã€ç­¾åä¸åŒ¹é…(SignatureException)éƒ½ä¼šèµ°è¿›è¿™é‡Œ\n            return false;\n        }\n    }\n\n    public String extractUserId(String token) {\n        return Jwts.parser()\n            .verifyWith(Keys.hmacShaKeyFor(secretKey.getBytes()))\n            .build()\n            .parseSignedClaims(token)\n            .getPayload()\n            .getSubject(); // ğŸ’¡ ä¸šç•Œæƒ¯ä¾‹ï¼Œç”± Sub (Subject) å­—æ®µæºå¸¦ User ID\n    }\n}\n`,
        comments: [
            { line: 10, text: '// ğŸ’¡ åŠ å¯†åŸºç¡€è®¾æ–½ï¼šHMAC å¯†é’¥' },
            { line: 17, text: '// ğŸ’¡ è¿™é‡ŒéªŒè¯äº†ä»¤ç‰Œæ˜¯ç”±æˆ‘ä»¬çš„æœåŠ¡å™¨æ´¾å‘çš„ï¼Œæ²¡æœ‰ä»»ä½•ä¸­å¿ƒæ•°æ®åº“çš„ IO äº¤äº’' },
            { line: 22, text: '// ğŸ’¡ å¯¹äºè¢«æ‹¦æˆªå™¨æŠ“åˆ°çš„å¼‚å¸¸ï¼Œè¿”å› false (æ‹¦æˆªå‰ç«¯å¹¶å¼•å¯¼å» /login)' },
            { line: 34, text: '// ğŸ’¡ å³å°†äº¤ç”±ä¸‹ä¸€æ­¥ï¼šæºå¸¦æ­¤ UserID å†™å…¥ç‚¹èµè¡¨' },
        ],
        diagramMarkup: `sequenceDiagram\n    participant Frontend as å‰ç«¯åº”ç”¨\n    participant AuthFilter as JWT è¿‡æ»¤å™¨\n    participant Service as ç‚¹èµæœåŠ¡\n    \n    Frontend->>AuthFilter: POST /api/like (å¤´å¸¦ Bearer ey...)\n    AuthFilter->>AuthFilter: Jwts.parser().verifyWith(ç§˜é’¥)\n    alt Token å¤±æ•ˆ/ç¯¡æ”¹\n        AuthFilter-->>Frontend: 401 Unauthorized\n    else Token åˆæ³•\n        AuthFilter->>Service: è·å–å…¶ä¸­æç‚¼çš„ UserIDï¼Œæ”¾è¡Œä¸šåŠ¡\n        Service-->>Frontend: 200 OK (ğŸ‘ æˆåŠŸ)\n    end`,
    },
    {
        id: 'be-2-2', type: 'backend',
        title: 'è¯¾ç¨‹ 2.2ï¼šä½¿ç”¨ Redis é™ä½æ•°æ®åº“å‹åŠ›',
        category: 'æ¨¡å—2ï¼šè®¤è¯ä¸ç¼“å­˜ä¸­é—´ä»¶', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 2, lessonNumber: 2, language: 'java',
        startingCode: '',
        instructions: `# ç¼“å­˜å‰å“¨ï¼šRedis é›†æˆ\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\næ¯ä¸ªäººçš„ä¸»é¡µæ˜¾ç¤ºçš„â€œè§†é¢‘è¯¦æƒ…â€å’Œâ€œè§†é¢‘è¢«æµè§ˆçš„æ¬¡æ•°â€æ˜¯å¹³å°ä¸­è®¿é—®æœ€é¢‘ç¹çš„è¯»è¯·æ±‚ï¼ˆRead-heavyï¼‰ã€‚å¦‚æœæ¯ä¸€æ¬¡è¯·æ±‚éƒ½åƒ 1.2 è¯¾é‚£æ ·æ‰“åˆ° MySQLï¼Œæ•°æ®åº“åˆ†åˆ†é’Ÿ CPU å‘Šè­¦ï¼Œä¹Ÿå°±æ˜¯ä¸šåŠ¡æ¶æ„ä¸­çš„â€œé›ªå´©â€ã€‚\nRedis æ˜¯å•çº¿ç¨‹ã€åŸºäºå†…å­˜çš„ NoSQLï¼Œå•æœº QPS å¯ç ´åä¸‡ï¼Œæˆ‘ä»¬å°†å®ƒç”¨ä½œæŒ¡åœ¨ MySQL é¢å‘ç‚®ç«çš„ç¬¬ä¸€å±‚æ©ä½“ã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- Redis \`StringRedisTemplate\` å’Œåºåˆ—åŒ–å­˜å‚¨ã€‚`,
        targetCode: `package com.codeforge.video.service;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.stereotype.Service;\nimport java.util.concurrent.TimeUnit;\n\n@Service\npublic class VideoCacheService {\n\n    // ğŸ’¡ Spring Data Redis çš„é«˜é˜¶æŠ½è±¡ï¼Œä¸“é—¨å¤„ç†æ–‡æœ¬å­—ç¬¦ä¸²ï¼ˆJSONï¼‰\n    @Autowired\n    private StringRedisTemplate redisTemplate;\n\n    public String getCachedVideo(String videoId) {\n        // ğŸ’¡ O(1) çš„è¶…æé€Ÿå“ˆå¸Œç´¢å–\n        return redisTemplate.opsForValue().get("video:detail:" + videoId);\n    }\n\n    public void cacheVideo(String videoId, String jsonPayload) {\n        // ğŸ’¡ Cache Aside æ¨¡å¼ï¼šæŸ¥ä¸åˆ°åº“æ—¶æŸ¥DBï¼ŒæŸ¥å®Œå¡å›ç¼“å­˜ï¼Œä½†ä¸€å®šè¦è®¾è¿‡æœŸæ—¶é—´ï¼(TTL)\n        redisTemplate.opsForValue()\n            .set("video:detail:" + videoId, jsonPayload, 1, TimeUnit.HOURS);\n    }\n\n    // ğŸ’¡ Redis å•çº¿ç¨‹çš„å¤©èµ‹èƒ½åŠ›â€”â€”åŸå­çš„é€’å¢ï¼Œä¸åŠ é”ä¹Ÿèƒ½ç¡®ä¿é«˜å¹¶å‘ä¸‹ä¸ä¸¢æ•°æ®\n    public void incrementViews(String videoId) {\n        redisTemplate.opsForValue().increment("video:views:" + videoId);\n    }\n}\n`,
        comments: [
            { line: 12, text: '// ğŸ’¡ æä½å»¶è¿Ÿçš„æ•°æ®ç®¡çº¿' },
            { line: 22, text: '// ğŸ’¡ è®¾å®š 1 å°æ—¶è¿‡æœŸ (TTL)ï¼Œé˜²æ­¢åƒµå°¸æ•°æ®å æ»¡ç³»ç»Ÿçè´µçš„å†…å­˜' },
            { line: 27, text: '// ğŸ’¡ è¿™æ˜¯åº”å¯¹å¹¶å‘å†™çš„æœ€å¿«è§£æ³•ï¼å®ƒæ¯”å‘ä¸€æ¬¡ Kafka æˆ–åŠ æ•°æ®åº“è¡Œé”éƒ½å¿«' },
        ],
        diagramMarkup: `sequenceDiagram\n    participant Frontend as æ‰‹æœºç«¯\n    participant Cache as Redis å†…å­˜ç¼“å­˜\n    participant DB as MySQL ç¡¬ç›˜ä¸»åº“\n    \n    Frontend->>Cache: æŸ¥ video:detail:99\n    alt Cache Hit (ç¼“å­˜å‘½ä¸­ç›´æ¥è¿”å›)\n        Cache-->>Frontend: æ¯«ç§’çº§è¿”å› JSON\n    else Cache Miss (ç¼“å­˜æœªå‘½ä¸­)\n        Cache--xFrontend: null\n        Frontend->>DB: æ…¢é€Ÿç¡¬ç›˜æŸ¥è¯¢ SQL\n        DB-->>Frontend: è¿”å›æ•°æ®å¹¶å¼‚æ­¥å†™å› Redis\n    end`,
    },
    {
        id: 'be-3-1', type: 'backend',
        title: 'è¯¾ç¨‹ 3.1ï¼šKafka é«˜å¹¶å‘ç‚¹èµæµâ€œå‰Šå³°å¡«è°·â€',
        category: 'æ¨¡å—3ï¼šäº‹ä»¶é©±åŠ¨ä¸å®¹é”™ç³»ç»Ÿ', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 3, lessonNumber: 1, language: 'java',
        startingCode: '',
        instructions: `# å¼•å…¥ Kafka è¿›è¡Œæµå¼å‰Šå³°\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nè¿˜è®°å¾—æˆ‘ä»¬åœ¨å‰ç«¯ M3 è¯¾é‡Œç”»çš„ \`InteractiveLikeButton\`ï¼ˆäº’åŠ¨ç‚¹èµæŒ‰é’®ï¼‰å—ï¼Ÿå¦‚æœæŸç½‘çº¢è§†é¢‘çˆ†ç«ï¼Œ1ç§’å†…æœ‰ 10 ä¸‡äººè¿ç»­ç‚¹èµï¼Œæ•°æ®åº“çš„è¡Œé”ä¼šå¯¼è‡´ä¸¥é‡çš„é˜»å¡ã€‚ \næˆ‘ä»¬ç”¨ Apache Kafka å–ä»£ç›´æ¥å†™å…¥ DBã€‚Kafka å°†æ´ªå³°ä¸€æ ·çš„è¯·æ±‚åƒå­˜æ°´åº“ä¸€æ ·å­˜å…¥ Logï¼ˆ**å‰Šå³°**ï¼‰ï¼Œè€Œåç«¯æ¶ˆè´¹çº¿ç¨‹æŒ‰ç…§æ•°æ®åº“èƒ½æ¥å—çš„èƒ½åŠ›æ…¢æ…¢å¾€æ•°æ®åº“å†™ï¼ˆ**å¡«è°·**ï¼‰ã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- \`KafkaTemplate\` æ¨é€äº‹ä»¶ã€‚\n- Kafka é«˜çº§è¯é¢˜ï¼šå¼‚æ­¥å›è°ƒã€‚`,
        targetCode: `package com.codeforge.social.producer;\n\nimport org.springframework.kafka.core.KafkaTemplate;\nimport org.springframework.stereotype.Service;\n\n@Service\npublic class LikeEventProducer {\n\n    // ğŸ’¡ Spring Kafka å¯¹åŸç”Ÿ Producer çš„åŒ…è£…\n    private final KafkaTemplate<String, String> kafkaTemplate;\n\n    public LikeEventProducer(KafkaTemplate<String, String> kafkaTemplate) {\n        this.kafkaTemplate = kafkaTemplate;\n    }\n\n    public void sendLikeEvent(String userId, String videoId) {\n        // ğŸ’¡ æ„é€ äº‹ä»¶ã€‚åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ JSON æˆ– Avro åºåˆ—åŒ–\n        String payload = String.format("{\\"user\\":\\"%s\\", \\"video\\":\\"%s\\"}", userId, videoId);\n\n        // ğŸ’¡ æ ¸å¿ƒï¼šæŠŠä¸šåŠ¡æ•°æ®æŒ‰è§†é¢‘ ID ä½œä¸ºåˆ†åŒºé”®ï¼ˆPartition Keyï¼‰å‘é€åˆ°ç‰¹å®šçš„ä¸»é¢˜ä¸­ï¼ˆTopicï¼‰\n        // ç›¸åŒ videoId çš„ç‚¹èµä¸€å®šä¼šè¿›å…¥åŒä¸€ä¸ªåˆ†åŒºï¼Œç¡®ä¿äº†åŒä¸€è§†é¢‘åœ¨æ¶ˆè´¹æ—¶çš„æœ‰åºæ€§\n        kafkaTemplate.send("video-likes-topic", videoId, payload)\n            .whenComplete((result, ex) -> {\n                if (ex != null) {\n                    // ğŸ’¡ ç½‘ç»œæŠ–åŠ¨å‘ç”Ÿæ—¶è®°å½•æ—¥å¿—æˆ–ä¿å­˜è‡³ä¸“é—¨çš„é‡è¯•è¡¨\n                    System.err.println("å‘é€ Kafka å¤±è´¥ï¼š" + ex.getMessage());\n                }\n            });\n    }\n}\n`,
        comments: [
            { line: 9, text: '// ğŸ’¡ è¿™ä¸ª Bean å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå¤šè·¯å¤ç”¨çš„ TCP æŒä¹…è¿æ¥' },
            { line: 21, text: '// ğŸ’¡ æŒ‡å®š Key æ˜¯ Kafka ä¿è¯å±€éƒ¨é¡ºåºçš„æ ¸å¿ƒæœºåˆ¶' },
            { line: 23, text: '// ğŸ’¡ å¼‚æ­¥éé˜»å¡çš„ CompletableFutureï¼Œé‡Šæ”¾å½“å‰ HTTP çº¿ç¨‹çš„å‹åŠ›ï¼Œæ”¯æ’‘æµ·é‡ååé‡' },
        ],
        diagramMarkup: `sequenceDiagram\n    participant API as LikeController\n    participant Kafka as Kafka æ¶ˆæ¯å¼•æ“\n    participant Consumer as Async æ¶ˆè´¹å±‚\n    participant DB as MySQL\n    \n    Note over API: ç§’çº§å¹¶å‘ 10ä¸‡ \n    API->>API: ç»„è£… JSON äº‹ä»¶\n    API--)Kafka: å¼‚æ­¥æŠ•å…¥ video-likes-topic (ååæå¤§)\n    API-->>å®¢æˆ·ç«¯: 200 OK (å…¶å®æ­¤æ—¶ DB è¿˜æ²¡è½ç›˜ï¼Œä½†å‰ç«¯ä¹è§‚æ›´æ–°å‘ˆç°å·²èµ)\n    \n    Note over Consumer: å‰Šå³°æ…¢é€Ÿæ¶ˆè´¹\n    Kafka-->>Consumer: æŒç»­æ‰¹é‡æŠ•é€’äº‹ä»¶\n    Consumer->>DB: ç¨³æ‰ç¨³æ‰“åˆå¹¶å…¥åº“`,
    },
    {
        id: 'be-3-2', type: 'backend',
        title: 'è¯¾ç¨‹ 3.2ï¼šKafka å¼‚å¸¸æŠ¤åŸæ²³â€”â€”æ­»ä¿¡é˜Ÿåˆ— (DLQ)',
        category: 'æ¨¡å—3ï¼šäº‹ä»¶é©±åŠ¨ä¸å®¹é”™ç³»ç»Ÿ', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 3, lessonNumber: 2, language: 'java',
        startingCode: '',
        instructions: `# å¼‚å¸¸æŠ¤åŸæ²³ï¼šDead Letter Queue\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nå½“ Kafka æ¶ˆè´¹è€…æ­£è¦å°†â€œç‚¹èµäº‹ä»¶â€å†™è¿› MySQL æ—¶ï¼Œå¦‚æœæ•°æ®åº“ä¸»åº“åˆšå¥½åœ¨è¿™ä¸ªç¬é—´å®•æœºäº†ï¼Œæˆ–è€…å› ä¸ºç½‘ç»œæ³¢åŠ¨è¿™è¡Œè®°å½•å†™ä¸è¿›å»ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ\nå¦‚æœä¸å¤„ç†ï¼Œè¿™ä¸ªç‚¹èµå°±æ°¸è¿œä¸¢å¤±äº†ï¼›å¦‚æœæ— é™é‡è¯•ï¼Œé˜Ÿåˆ—æ°¸è¿œå¡æ­»åœ¨è¿™æ¡æ¶ˆæ¯ä¸Šä¸å‰è¿›ï¼ˆæ¯’è¯æ¶ˆæ¯ï¼‰ã€‚\næ ‡å‡†æ–¹æ¡ˆæ˜¯ï¼šå¤šæ¬¡é‡è¯•åå¦‚æœä¾ç„¶å¤±è´¥ï¼Œå°†è¢«è¸¢å…¥éš”ç¦»åŒºâ€”â€”å³æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead Letter Queue, DLQï¼‰ã€‚è¿ç»´äººå‘˜ä¹‹åå¯¹ DLQ è¿›è¡Œè¡¥å¿ï¼ˆäººå·¥æˆ–è„šæœ¬æ¢å¤ï¼‰ã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- \`@KafkaListener\` æ³¨è§£ã€‚\n- æ­»ä¿¡é˜Ÿåˆ—åœ¨ä¼ä¸šçº§é¡¹ç›®ä¸­çš„ä½¿ç”¨å®šå¼ã€‚`,
        targetCode: `package com.codeforge.social.consumer;\n\nimport org.springframework.kafka.annotation.KafkaListener;\nimport org.springframework.kafka.core.KafkaTemplate;\nimport org.springframework.stereotype.Component;\n\n@Component\npublic class LikeEventConsumer {\n\n    private final KafkaTemplate<String, String> kafkaTemplate;\n\n    public LikeEventConsumer(KafkaTemplate<String, String> kafkaTemplate) {\n        this.kafkaTemplate = kafkaTemplate;\n    }\n\n    // ğŸ’¡ æ¶ˆè´¹è€…ç›‘å¬ä¸»éš§é“ã€‚è¿™é‡Œçš„ groupId æ˜¯æ ‡è¯†æˆ‘ä»¬ä¸ºâ€œç‚¹èµç»Ÿè®¡å¾®æœåŠ¡ç»„â€\n    @KafkaListener(topics = "video-likes-topic", groupId = "social-counters-group")\n    public void consumeLikeEvent(String payload) {\n        try {\n            // ğŸ’¡ æ¨¡æ‹Ÿè°ƒç”¨ Mybatis Mapper è½ç›˜å…¥åº“...\n            processToDb(payload);\n        } catch (Exception e) {\n            // ğŸ’¡ è¢«é€¼ä¸Šç»è·¯ï¼šåœ¨å°è¯•æ•è·å¹¶å±€éƒ¨é‡è¯•ä¾ç„¶å®£å‘Šç ´äº§åï¼Œæ¨å…¥éš”ç¦»æ·±æ¸Š\n            System.err.println("æ•°æ®å…¥åº“å´©æºƒï¼Œè½¬ç§»è‡³ DLQ ä¿é™©ç®±");\n            \n            // ğŸ’¡ è·¯ç”±åˆ°ä»¥ .dlq ç»“å°¾çš„æ­»ä¿¡éš§é“ä¸­\n            kafkaTemplate.send("video-likes-topic.dlq", payload);\n        }\n    }\n\n    private void processToDb(String payload) {\n        // å½“ DB æŒ‚æ‰æ—¶ï¼ŒæŠ›å‡ºå‡æƒ³å¼‚å¸¸\n        throw new RuntimeException("Database Connection Timeout");\n    }\n}\n`,
        comments: [
            { line: 17, text: '// ğŸ’¡ Spring Kafka çš„å¼‚æ­¥ç›‘å¬å™¨' },
            { line: 20, text: '// ğŸ’¡ æœ¬åº”è¯¥æ˜¯åœ¨è¿™å¾€ DB é‡Œå¹³ç¨³æ³¨å…¥æ•°æ®' },
            { line: 27, text: '// ğŸ’¡ ä¸€ç§ä¼˜é›…çš„å¦¥åæœºåˆ¶ï¼Œä¸ºäº†ä¿å…¨å±€å¯ç”¨æ€§å°†å¼‚å¸¸åˆ†æµ' },
        ],
        diagramMarkup: `sequenceDiagram\n    participant Kafka as å®šå¸¸æµæ•°æ®\n    participant Consumer as ä¸šåŠ¡æœºå™¨\n    participant DB as MySQL\n    participant DLQ as æ­»ä¿¡ä¸“å± Topic\n    \n    Kafka-->>Consumer: æ‹‰å– 1 æ¡ç‚¹èµ JSON\n    Consumer->>DB: å°è¯•æ’å…¥\n    DB--xConsumer: Connection Refused (DBæŒ‚æ‰)\n    Note over Consumer: æ‹¦æˆªåˆ°è‡´å‘½å¼‚å¸¸\n    Consumer--)DLQ: æ‰”è¿› video-likes.dlq ä»¥å¾…æŠ¢æ•‘\n    Note right of Consumer: æœºå™¨ç»§ç»­æ¶ˆè´¹ Kafka åç»­æœ€æ–°æ•°æ®ä¸å—å¡è„–å­å½±å“`,
    },
];
