import type { Lesson } from '../types';

export const frontendM3M5: Lesson[] = [
    {
        id: 'fe-3-1', type: 'frontend',
        title: '课程 3.1：Next.js 简介 — 从 CSR 到 SSR',
        category: '模块3：Next.js 渲染范式', track: '前端架构',
        moduleNumber: 3, lessonNumber: 1, language: 'typescript',
        startingCode: '',
        instructions: `# Next.js 简介：从客户端渲染到服务端渲染\n\n## 学习目标\n- 理解 CSR、SSR 和 SSG 三种渲染策略的差异\n- 掌握 Next.js App Router 的文件路由约定\n- 使用 \`generateMetadata\` 优化 SEO`,
        targetCode: `import type { Metadata } from 'next';\n\nexport const metadata: Metadata = {\n  title: 'Video Feed - CodeForge',\n  description: 'High-performance video streaming platform',\n};\n\ninterface Video {\n  id: string;\n  title: string;\n  views: number;\n  thumbnail: string;\n}\n\nasync function getVideos(): Promise<Video[]> {\n  const res = await fetch('https://api.example.com/videos', {\n    next: { revalidate: 60 },\n  });\n  if (!res.ok) throw new Error('Failed to fetch');\n  return res.json();\n}\n\nexport default async function VideoPage() {\n  const videos = await getVideos();\n\n  return (\n    <main className="max-w-4xl mx-auto p-8">\n      <h1 className="text-3xl font-bold mb-8">Trending Videos</h1>\n      <div className="grid grid-cols-2 gap-6">\n        {videos.map(v => (\n          <div key={v.id} className="rounded-xl overflow-hidden bg-gray-50">\n            <img src={v.thumbnail} alt={v.title} className="w-full h-48 object-cover" />\n            <div className="p-4">\n              <h3 className="font-semibold">{v.title}</h3>\n              <p className="text-sm text-gray-500">{v.views.toLocaleString()} views</p>\n            </div>\n          </div>\n        ))}\n      </div>\n    </main>\n  );\n}\n`,
        comments: [
            { line: 3, text: '// Next.js Metadata API：服务端生成 SEO 标签' },
            { line: 17, text: '// ISR：revalidate: 60 每60秒后台更新缓存' },
            { line: 23, text: '// Server Component：async 函数直接在服务端执行' },
        ],
    },
    {
        id: 'fe-3-2', type: 'frontend',
        title: '课程 3.2：React 服务器组件 (RSC)',
        category: '模块3：Next.js 渲染范式', track: '前端架构',
        moduleNumber: 3, lessonNumber: 2, language: 'typescript',
        startingCode: '',
        instructions: `# React 服务器组件\n\n## 学习目标\n- 区分 Server Component 和 Client Component\n- 在服务端安全获取数据并传递给客户端组件\n- 使用 \`'use client'\` 标记交互式组件`,
        targetCode: `import VideoPlayer from './VideoPlayer';\n\ninterface VideoDetail {\n  id: string;\n  title: string;\n  author: string;\n  videoUrl: string;\n  likes: number;\n  comments: { id: string; text: string; user: string }[];\n}\n\nasync function getVideo(id: string): Promise<VideoDetail> {\n  const res = await fetch(\`https://api.example.com/videos/\${id}\`, {\n    cache: 'no-store',\n  });\n  return res.json();\n}\n\nexport default async function VideoPage({ params }: { params: { id: string } }) {\n  const video = await getVideo(params.id);\n\n  return (\n    <div className="max-w-3xl mx-auto p-8">\n      <VideoPlayer url={video.videoUrl} />\n      <h1 className="text-2xl font-bold mt-4">{video.title}</h1>\n      <p className="text-gray-500">@{video.author}</p>\n      <section className="mt-6 space-y-3">\n        <h2 className="font-semibold">Comments ({video.comments.length})</h2>\n        {video.comments.map(c => (\n          <div key={c.id} className="p-3 rounded-lg bg-gray-50">\n            <span className="font-medium text-sm">{c.user}</span>\n            <p className="text-sm text-gray-600">{c.text}</p>\n          </div>\n        ))}\n      </section>\n    </div>\n  );\n}\n`,
        comments: [
            { line: 1, text: '// Server Component 可以直接导入 Client Component' },
            { line: 14, text: '// cache: no-store 强制每次请求都获取最新数据' },
            { line: 19, text: '// async Server Component：数据在服务端获取，零客户端请求' },
        ],
    },
    {
        id: 'fe-3-3', type: 'frontend',
        title: '课程 3.3：岛屿架构概念',
        category: '模块3：Next.js 渲染范式', track: '前端架构',
        moduleNumber: 3, lessonNumber: 3, language: 'typescript',
        startingCode: '',
        instructions: `# 岛屿架构：细粒度交互\n\n## 学习目标\n- 理解"静态海洋中的交互岛屿"概念\n- 识别哪些组件需要客户端 JS（交互岛屿），哪些可以保持纯服务端\n- 使用 React Suspense 实现渐进式 hydration`,
        targetCode: `'use client';\n\nimport { useState, Suspense } from 'react';\n\ninterface LikeButtonProps {\n  videoId: string;\n  initialLikes: number;\n}\n\nexport function LikeButton({ videoId, initialLikes }: LikeButtonProps) {\n  const [likes, setLikes] = useState(initialLikes);\n  const [liked, setLiked] = useState(false);\n\n  const handleLike = async () => {\n    setLiked(!liked);\n    setLikes(prev => liked ? prev - 1 : prev + 1);\n    await fetch(\`/api/videos/\${videoId}/like\`, { method: 'POST' });\n  };\n\n  return (\n    <button\n      onClick={handleLike}\n      className={\`px-4 py-2 rounded-full font-medium transition-colors \${\n        liked ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-700'\n      }\`}\n    >\n      {liked ? 'Liked' : 'Like'} ({likes})\n    </button>\n  );\n}\n\nexport function CommentSection({ videoId }: { videoId: string }) {\n  const [comment, setComment] = useState('');\n\n  return (\n    <div className="mt-6 p-4 rounded-xl border border-gray-200">\n      <textarea\n        value={comment}\n        onChange={e => setComment(e.target.value)}\n        placeholder="Add a comment..."\n        className="w-full p-3 rounded-lg border border-gray-200 resize-none"\n        rows={3}\n      />\n      <button\n        onClick={() => { setComment(''); }}\n        className="mt-2 px-4 py-2 rounded-lg bg-blue-600 text-white"\n      >\n        Post\n      </button>\n    </div>\n  );\n}\n`,
        comments: [
            { line: 1, text: '// "use client" 标记：这是一个交互岛屿，需要客户端 JS' },
            { line: 10, text: '// LikeButton 岛屿：乐观更新 UI，后台发请求' },
            { line: 32, text: '// CommentSection 岛屿：独立的交互区域' },
        ],
    },
    {
        id: 'fe-3-task', type: 'frontend',
        title: '实战：将 Vite 视频流重构为 Next.js 应用',
        category: '模块3：Next.js 渲染范式', track: '前端架构',
        moduleNumber: 3, lessonNumber: 4, language: 'typescript',
        startingCode: '',
        instructions: `# 启发式任务：重构为 Next.js\n\n## 任务目标\n将前面的视频流从纯 CSR Vite 应用重构为 Next.js 应用，利用 SSR 提升首屏加载性能和 SEO。`,
        targetCode: `import { Suspense } from 'react';\nimport { LikeButton } from '@/components/LikeButton';\n\ninterface Video {\n  id: string;\n  title: string;\n  thumbnail: string;\n  views: number;\n  likes: number;\n}\n\nasync function getTrendingVideos(): Promise<Video[]> {\n  const res = await fetch('https://api.example.com/videos/trending', {\n    next: { revalidate: 300 },\n  });\n  return res.json();\n}\n\nexport default async function TrendingPage() {\n  const videos = await getTrendingVideos();\n\n  return (\n    <main className="max-w-5xl mx-auto p-8">\n      <h1 className="text-3xl font-bold mb-8">Trending</h1>\n      <div className="grid grid-cols-3 gap-6">\n        {videos.map(v => (\n          <article key={v.id} className="rounded-xl overflow-hidden bg-white border border-gray-200">\n            <img src={v.thumbnail} alt={v.title} className="w-full h-44 object-cover" />\n            <div className="p-4">\n              <h2 className="font-semibold">{v.title}</h2>\n              <p className="text-sm text-gray-500 mt-1">{v.views.toLocaleString()} views</p>\n              <Suspense fallback={<span>...</span>}>\n                <LikeButton videoId={v.id} initialLikes={v.likes} />\n              </Suspense>\n            </div>\n          </article>\n        ))}\n      </div>\n    </main>\n  );\n}\n`,
        comments: [
            { line: 14, text: '// ISR：5分钟缓存，平衡性能与数据新鲜度' },
            { line: 19, text: '// Server Component：数据获取在服务端完成' },
            { line: 32, text: '// Suspense 包裹 Client Component LikeButton' },
        ],
    },
    {
        id: 'fe-4-1', type: 'frontend',
        title: '课程 4.1：微前端与 Monorepo（Turborepo）',
        category: '模块4：企业组织与微前端', track: '前端架构',
        moduleNumber: 4, lessonNumber: 1, language: 'typescript',
        startingCode: '',
        instructions: `# 微前端与 Monorepo\n\n## 学习目标\n- 理解微前端的概念和适用场景\n- 使用 Turborepo 管理多应用、多包的大型代码库\n- 配置工作空间（Workspace）实现包共享`,
        targetCode: `{\n  "name": "codeforge-monorepo",\n  "private": true,\n  "workspaces": [\n    "apps/*",\n    "packages/*"\n  ],\n  "devDependencies": {\n    "turbo": "^2.0.0"\n  },\n  "scripts": {\n    "dev": "turbo dev",\n    "build": "turbo build",\n    "lint": "turbo lint",\n    "test": "turbo test"\n  }\n}\n`,
        comments: [
            { line: 3, text: '// workspaces：定义 apps 和 packages 两个目录' },
            { line: 8, text: '// Turborepo：智能缓存和并行构建' },
            { line: 12, text: '// turbo dev：并行启动所有 apps 的开发服务器' },
        ],
    },
    {
        id: 'fe-4-2', type: 'frontend',
        title: '课程 4.2：Webpack 模块联合',
        category: '模块4：企业组织与微前端', track: '前端架构',
        moduleNumber: 4, lessonNumber: 2, language: 'typescript',
        startingCode: '',
        instructions: `# Webpack 模块联合：动态加载独立应用\n\n## 学习目标\n- 使用 Module Federation 在运行时动态加载远程模块\n- 配置 Host 和 Remote 应用\n- 实现独立部署、独立版本的微前端`,
        targetCode: `const { ModuleFederationPlugin } = require('webpack').container;\n\nmodule.exports = {\n  plugins: [\n    new ModuleFederationPlugin({\n      name: 'host_app',\n      remotes: {\n        analytics: 'analytics@http://localhost:3002/remoteEntry.js',\n        feed: 'feed@http://localhost:3003/remoteEntry.js',\n      },\n      shared: {\n        react: { singleton: true, requiredVersion: '^18.0.0' },\n        'react-dom': { singleton: true, requiredVersion: '^18.0.0' },\n      },\n    }),\n  ],\n};\n`,
        comments: [
            { line: 5, text: '// Host 应用：声明要加载的远程微前端' },
            { line: 7, text: '// remotes：运行时从 URL 动态加载远程模块' },
            { line: 11, text: '// shared：React 作为单例共享，防止多份实例冲突' },
        ],
    },
    {
        id: 'fe-4-task', type: 'frontend',
        title: '实战：拆分为 Monorepo 架构',
        category: '模块4：企业组织与微前端', track: '前端架构',
        moduleNumber: 4, lessonNumber: 3, language: 'typescript',
        startingCode: '',
        instructions: `# 启发式任务：拆分为 Monorepo\n\n## 任务目标\n将 Next.js 应用拆分为 Monorepo：共享 UI 包、主信息流应用和分析仪表盘应用。`,
        targetCode: `{\n  "pipeline": {\n    "build": {\n      "dependsOn": ["^build"],\n      "outputs": [".next/**", "dist/**"]\n    },\n    "dev": {\n      "cache": false,\n      "persistent": true\n    },\n    "lint": {\n      "dependsOn": ["^build"]\n    },\n    "test": {\n      "dependsOn": ["build"]\n    }\n  }\n}\n`,
        comments: [
            { line: 3, text: '// build 依赖上游包的构建输出' },
            { line: 7, text: '// dev 不缓存：开发模式需要实时更新' },
            { line: 8, text: '// persistent: true — dev 服务器保持运行' },
        ],
    },
    {
        id: 'fe-5-1', type: 'frontend',
        title: '课程 5.1：从 DOM 到原生移动组件',
        category: '模块5：React Native', track: '前端架构',
        moduleNumber: 5, lessonNumber: 1, language: 'typescript',
        startingCode: '',
        instructions: `# 从 DOM 过渡到原生移动组件\n\n## 学习目标\n- 理解 React Native 核心组件：View、Text、ScrollView、TouchableOpacity\n- 掌握 StyleSheet API 替代 CSS 类名\n- 对比 Web div/span 与 Native View/Text`,
        targetCode: `import React from 'react';\nimport { View, Text, ScrollView, TouchableOpacity, StyleSheet } from 'react-native';\n\ninterface ItemProps {\n  title: string;\n  subtitle: string;\n  onPress: () => void;\n}\n\nfunction ListItem({ title, subtitle, onPress }: ItemProps) {\n  return (\n    <TouchableOpacity onPress={onPress} style={styles.item}>\n      <View style={styles.content}>\n        <Text style={styles.title}>{title}</Text>\n        <Text style={styles.subtitle}>{subtitle}</Text>\n      </View>\n    </TouchableOpacity>\n  );\n}\n\nexport default function SettingsScreen() {\n  const sections = [\n    { title: 'Account', subtitle: 'Profile, email, password' },\n    { title: 'Notifications', subtitle: 'Push, email alerts' },\n    { title: 'Appearance', subtitle: 'Dark mode, font size' },\n    { title: 'Privacy', subtitle: '2FA, login history' },\n  ];\n\n  return (\n    <ScrollView style={styles.container}>\n      <Text style={styles.header}>Settings</Text>\n      {sections.map(s => <ListItem key={s.title} {...s} onPress={() => {}} />)}\n    </ScrollView>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: { flex: 1, backgroundColor: '#FFFFFF', padding: 16 },\n  header: { fontSize: 28, fontWeight: 'bold', color: '#202124', marginBottom: 24 },\n  item: { backgroundColor: '#F8F9FA', borderRadius: 16, padding: 16, marginBottom: 8 },\n  content: { flex: 1 },\n  title: { fontSize: 16, fontWeight: '600', color: '#202124' },\n  subtitle: { fontSize: 13, color: '#5F6368', marginTop: 2 },\n});\n`,
        comments: [
            { line: 2, text: '// React Native 核心组件：无 div/span，使用 View/Text' },
            { line: 12, text: '// TouchableOpacity：按下时降低透明度的触摸容器' },
            { line: 37, text: '// StyleSheet.create：编译时优化，比内联样式性能更好' },
        ],
    },
    {
        id: 'fe-5-2', type: 'frontend',
        title: '课程 5.2：在 Next.js 与 React Native 间共享逻辑',
        category: '模块5：React Native', track: '前端架构',
        moduleNumber: 5, lessonNumber: 2, language: 'typescript',
        startingCode: '',
        instructions: `# 在 Web 和移动端之间共享业务逻辑\n\n## 学习目标\n- 将业务逻辑和自定义 Hooks 提取到平台无关的共享包\n- 使用条件导出区分 Web 和 Native 平台\n- 在 Monorepo 中配置 packages/shared`,
        targetCode: `export interface Video {\n  id: string;\n  title: string;\n  views: number;\n  thumbnail: string;\n}\n\nexport async function fetchVideos(page: number): Promise<Video[]> {\n  const res = await fetch(\`https://api.example.com/videos?page=\${page}\`);\n  if (!res.ok) throw new Error('Failed to fetch videos');\n  return res.json();\n}\n\nexport function formatViews(views: number): string {\n  if (views >= 1_000_000) return (views / 1_000_000).toFixed(1) + 'M';\n  if (views >= 1_000) return (views / 1_000).toFixed(1) + 'K';\n  return views.toString();\n}\n\nexport function getTimeAgo(dateStr: string): string {\n  const diff = Date.now() - new Date(dateStr).getTime();\n  const hours = Math.floor(diff / 3_600_000);\n  if (hours < 1) return 'Just now';\n  if (hours < 24) return hours + 'h ago';\n  const days = Math.floor(hours / 24);\n  if (days < 30) return days + 'd ago';\n  return Math.floor(days / 30) + 'mo ago';\n}\n`,
        comments: [
            { line: 1, text: '// 共享类型：Web 和 Native 使用同一接口定义' },
            { line: 8, text: '// 共享 API 层：跨平台复用数据获取逻辑' },
            { line: 14, text: '// 纯函数工具：无任何平台依赖，可在任何环境使用' },
        ],
    },
    {
        id: 'fe-5-task', type: 'frontend',
        title: '实战：将视频流转换为 React Native 屏幕',
        category: '模块5：React Native', track: '前端架构',
        moduleNumber: 5, lessonNumber: 3, language: 'typescript',
        startingCode: '',
        instructions: `# 启发式任务：Web 到 Native 的视频流转换\n\n## 任务目标\n使用共享的业务逻辑包，将 Web 版视频流转为功能齐全的 React Native 移动屏幕。`,
        targetCode: `import React, { useState, useEffect } from 'react';\nimport { View, Text, FlatList, Image, StyleSheet, ActivityIndicator } from 'react-native';\nimport { fetchVideos, formatViews } from '@codeforge/shared';\nimport type { Video } from '@codeforge/shared';\n\nexport default function FeedScreen() {\n  const [videos, setVideos] = useState<Video[]>([]);\n  const [page, setPage] = useState(1);\n  const [loading, setLoading] = useState(false);\n\n  const loadMore = async () => {\n    if (loading) return;\n    setLoading(true);\n    const next = await fetchVideos(page);\n    setVideos(prev => [...prev, ...next]);\n    setPage(p => p + 1);\n    setLoading(false);\n  };\n\n  useEffect(() => { loadMore(); }, []);\n\n  return (\n    <FlatList\n      data={videos}\n      keyExtractor={v => v.id}\n      onEndReached={loadMore}\n      onEndReachedThreshold={0.5}\n      renderItem={({ item }) => (\n        <View style={styles.card}>\n          <Image source={{ uri: item.thumbnail }} style={styles.thumb} />\n          <View style={styles.info}>\n            <Text style={styles.title}>{item.title}</Text>\n            <Text style={styles.views}>{formatViews(item.views)} views</Text>\n          </View>\n        </View>\n      )}\n      ListFooterComponent={loading ? <ActivityIndicator /> : null}\n    />\n  );\n}\n\nconst styles = StyleSheet.create({\n  card: { flexDirection: 'row', padding: 12, borderBottomWidth: 1, borderBottomColor: '#E8EAED' },\n  thumb: { width: 120, height: 68, borderRadius: 8 },\n  info: { flex: 1, marginLeft: 12, justifyContent: 'center' },\n  title: { fontSize: 15, fontWeight: '600', color: '#202124' },\n  views: { fontSize: 12, color: '#5F6368', marginTop: 4 },\n});\n`,
        comments: [
            { line: 3, text: '// 从共享包导入：与 Web 版使用完全相同的 API 和工具' },
            { line: 26, text: '// FlatList.onEndReached：原生无限滚动，替代 IntersectionObserver' },
            { line: 37, text: '// ListFooterComponent：列表底部加载指示器' },
        ],
    },
];
