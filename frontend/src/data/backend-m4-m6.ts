import type { Lesson } from '../types';

export const backendM4M6: Lesson[] = [
    {
        id: 'be-4-1', type: 'backend',
        title: 'è¯¾ç¨‹ 4.1ï¼šå¾®æœåŠ¡ Saga è·¨åº“äº‹åŠ¡ï¼ˆè´­ä¹°ä¼šå‘˜ï¼‰',
        category: 'æ¨¡å—4ï¼šSaaS å¼¹æ€§ä¸åˆ†å¸ƒå¼äº‹åŠ¡', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 4, lessonNumber: 1, language: 'java',
        startingCode: '',
        instructions: `# SaaS æ ¸å¿ƒï¼šè´­ä¹°ä¼šå‘˜ä¸åˆ†å¸ƒå¼äº‹åŠ¡\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nå½“æˆ‘ä»¬çš„ç”¨æˆ·ä¸ºäº†å»å¹¿å‘Šè´­ä¹°â€œé«˜çº§ä¼šå‘˜â€æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ï¼š1. åœ¨æ”¯ä»˜åº“æ‰£å‡ä½™é¢ï¼›2. åœ¨ç”¨æˆ·åº“æ›´æ–°å…¶ VIP çŠ¶æ€ã€‚å¦‚æœç¬¬ä¸€æ­¥æˆåŠŸï¼Œç¬¬äºŒæ­¥æœºå™¨æŒ‚äº†ï¼Œé’±æ‰£äº†å´æ²¡ç»™ VIP æƒé™ï¼Œç”¨æˆ·ä¸€å®šä¼šèµ·è¯‰å…¬å¸ã€‚\nåœ¨å¾®æœåŠ¡ä¸­ï¼Œè¿™å«è·¨åº“çš„**åˆ†å¸ƒå¼æ­»ç»“**ã€‚æˆ‘ä»¬å¼•å…¥ Saga æ¨¡å¼ä¸è¡¥å¿æœºåˆ¶ï¼ˆCompensating Actionï¼‰æ¥ä¿éšœæ•°æ®æœ€ç»ˆä¸€è‡´ã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- \`@Transactional\` æ— æ³•è·¨åº“çš„å±€é™ã€‚\n- åŸºäº Kafka ç¼–æ’çš„ Saga åˆ†å¸ƒå¼äº‹åŠ¡ã€‚`,
        targetCode: `package com.codeforge.payment.saga;\n\nimport org.springframework.kafka.annotation.KafkaListener;\nimport org.springframework.kafka.core.KafkaTemplate;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\n\n@Service\npublic class VipSubscriptionSaga {\n    \n    // ğŸ’¡ T1: Payment å¾®æœåŠ¡å…ˆè¡Œæ‰£æ¬¾\n    @Transactional\n    public void initiateVipPurchase(String userId, double amount) {\n        // æœ¬åœ°äº‹åŠ¡æ‰£é’±\n        paymentRepository.deduct(userId, amount);\n        // ğŸ’¡ åªæœ‰æœ¬åœ°äº‹åŠ¡æˆåŠŸï¼Œæ‰å¾€å¤–ä¸¢å‡ºä¿¡é¸½ï¼Œé€šçŸ¥ user æœåŠ¡\n        kafkaTemplate.send("vip-grant-requests", userId);\n    }\n\n    // ğŸ’¡ T2: User å¾®æœåŠ¡ç›‘å¬æ”¾è¡Œ\n    @KafkaListener(topics = "vip-grant-requests")\n    public void grantVipAccess(String userId) {\n        try {\n            // ç»™æƒé™\n            userRepository.makeVip(userId);\n        } catch (Exception e) {\n            // ğŸ’¡ è‡´å‘½æ—¶åˆ»ï¼šUser åº“æŒ‚äº†ï¼Œå¿…é¡»è§¦å‘ã€é€€æ¬¾åŠ¨ä½œã€‘\n            kafkaTemplate.send("vip-refund-compensation", userId);\n        }\n    }\n\n    // ğŸ’¡ T3: è¡¥å¿é€»è¾‘ï¼ˆCompensatory Transactionï¼‰- Payment å¾®æœåŠ¡é€€é’±\n    @KafkaListener(topics = "vip-refund-compensation")\n    public void executeRefund(String userId) {\n        System.out.println("è¡¥å¿æ‰§è¡Œï¼šé€€è¿˜ " + userId + " çš„ä¼šå‘˜è´¹");\n        paymentRepository.refund(userId, 9.99);\n    }\n}\n`,
        comments: [
            { line: 9, text: '// ğŸ’¡ äº‹åŠ¡ç¬¬ä¸€å—æ‹¼å›¾ï¼šæ‰£é’±ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰' },
            { line: 20, text: '// ğŸ’¡ äº‹åŠ¡ç¬¬äºŒå—æ‹¼å›¾ï¼šå‘å¾½ç« ' },
            { line: 25, text: '// ğŸ’¡ æ ¸å¿ƒåŸåˆ™ï¼šæ—¢ç„¶å‘ä¸å‡ºå»å¾½ç« ï¼Œå°±è®©ç®¡é’±çš„åŒæ—¶é€€æ¬¾' },
            { line: 31, text: '// ğŸ’¡ è¿™å« Saga çš„ Compensatingï¼ˆè¡¥å¿ï¼‰é˜¶æ®µ' },
        ],
        diagramMarkup: `sequenceDiagram\n    participant UI as å‰ç«¯ç»“è´¦é¡µ\n    participant Pay as æ”¯ä»˜å¾®æœåŠ¡\n    participant Kafka as Saga ç¼–æ’æ€»çº¿\n    participant User as ç”¨æˆ·å¾®æœåŠ¡\n    \n    UI->>Pay: POST /buy-vip\n    Pay->>Pay: DB: ä½™é¢-9.9 (Tx1)\n    Pay-)Kafka: Pub(vip-grant)\n    Pay-->>UI: 202 Accepted (å—ç†ä¸­)\n    \n    Kafka-->>User: Sub(vip-grant)\n    alt User æ›´æ–°æˆåŠŸ (Tx2)\n        User->>User: DB: is_vip=true\n    else User åº“å®•æœº\n        User-xUser: SQLException\n        User--)Kafka: Pub(vip-refund) [è§¦å‘å›æ»š]\n        Kafka-->>Pay: Sub(vip-refund)\n        Pay->>Pay: DB: ä½™é¢+9.9 è¡¥å¿ (Tx3)\n    end`,
    },
    {
        id: 'be-4-2', type: 'backend',
        title: 'è¯¾ç¨‹ 4.2ï¼šCircuit Breaker ç†”æ–­ä¸‹æ¸¸é˜²é›ªå´©',
        category: 'æ¨¡å—4ï¼šSaaS å¼¹æ€§ä¸åˆ†å¸ƒå¼äº‹åŠ¡', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 4, lessonNumber: 2, language: 'java',
        startingCode: '',
        instructions: `# ä½¿ç”¨ç†”æ–­å™¨æŠµæŠ—é›ªå´©æ•ˆåº”\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nçŸ­è§†é¢‘åº”ç”¨éœ€è¦è°ƒç”¨ç¬¬ä¸‰æ–¹çš„ CDN ï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰æœåŠ¡æ¥æŠ“å–è§†é¢‘çœŸæ­£çš„ç‰©ç†åœ°å€è¿›è¡Œæ’­æ”¾ã€‚å¦‚æœæŸä¸ªåœ°åŒºçš„ CDN èŠ‚ç‚¹æŒ‚äº†ï¼Œå¯¼è‡´æ‰€æœ‰çš„ API è¯·æ±‚éƒ½å µåœ¨é‚£ç­‰å¾… 30 ç§’è¶…æ—¶ï¼Œæ•´ä¸ª Spring Boot é›†ç¾¤çš„æ‰€æœ‰çº¿ç¨‹æœ€ç»ˆå°†è¢«è€—å°½è€Œå…¨é¢ç˜«ç—ªã€‚\næˆ‘ä»¬ä½¿ç”¨ **Resilience4j æ–­è·¯å™¨ï¼ˆCircuit Breakerï¼‰**ï¼Œå½“é”™è¯¯è¾¾åˆ°é˜ˆå€¼ï¼Œæœæ–­â€œç†”æ–­â€ï¼ˆFail Fastï¼‰ï¼Œè®©ç”¨æˆ·ç«‹åˆ»æŠ¥é”™è€Œä¸æ˜¯ç™½ç­‰ã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- \`@CircuitBreaker\` ä¿æŠ¤è„†å¼±çš„å¤–éƒ¨ç½‘ç»œè°ƒç”¨ã€‚\n- ç¼–å†™ Fallback é™çº§å…œåº•é€»è¾‘ã€‚`,
        targetCode: `package com.codeforge.video.client;\n\nimport io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker;\nimport org.springframework.stereotype.Service;\nimport org.springframework.web.client.RestTemplate;\n\n@Service\npublic class CdnUrlResolver {\n    \n    private final RestTemplate rest;\n\n    public CdnUrlResolver(RestTemplate rest) {\n        this.rest = rest;\n    }\n\n    // ğŸ’¡ å½“è¿œç«¯ CDN_URL è°ƒç”¨è¶…æ—¶æˆ– 500 æ¬¡æ•°è¾¾åˆ°è®¾å®šé˜ˆå€¼ï¼ˆæ¯”å¦‚ 50% å¤±è´¥ç‡ï¼‰ï¼Œ\n    // Spring ä¼šç›´æ¥åˆ‡æ–­å¯¹ CdnUrlResolver çš„è°ƒç”¨ï¼Œå¹¶ä¸”è½¬å‘æ‰§è¡Œ fallback æ–¹æ³•ã€‚\n    @CircuitBreaker(name = "cdnService", fallbackMethod = "defaultLocalVideo")\n    public String resolvePhysicalLocation(String videoId) {\n        // ğŸ’¡ æ¨¡æ‹Ÿæå…¶è„†å¼±å’Œç¼“æ…¢çš„ä¸‰æ–¹å¤–éƒ¨è°ƒç”¨\n        return rest.getForObject("http://fragile-cdn-provider/api/resolve/" + videoId, String.class);\n    }\n\n    // ğŸ’¡ é™çº§ï¼ˆFallbackï¼‰é¢„æ¡ˆï¼š\n    // æ³¨æ„å½¢å‚å¿…é¡»ä¸åŸæ–¹æ³•ä¸€è‡´ï¼Œä¸”æœ€åå¤šä¸€ä¸ª Throwable å…¥å‚æŠ“å–å¼‚å¸¸\n    public String defaultLocalVideo(String videoId, Throwable t) {\n        System.err.println("CDN èŠ‚ç‚¹ç†”æ–­ï¼å·²è‡ªåŠ¨é™çº§è‡³ç³»ç»Ÿå¤‡ç”¨å…œåº•å›¾åºŠï¼š" + t.getMessage());\n        // ğŸ’¡ å½“ç†”æ–­æ—¶ï¼Œç»™å‰ç«¯è¿”å›ä¸€ä¸ªç³»ç»Ÿé»˜è®¤çš„å…œåº•è§†é¢‘ï¼Œç»ä¸èƒ½è®© App é—ªé€€æˆ–è€…æ— é™è½¬åœˆï¼\n        return "https://backup-storage.codeforge.com/default-play.mp4";\n    }\n}\n`,
        comments: [
            { line: 18, text: '// ğŸ’¡ è´´ä¸Šè¿™å±‚é“ ç”²ï¼Œç”± Resilience4j ä¸ºå…¶å®ˆæœ›' },
            { line: 20, text: '// ğŸ’¡ é«˜å±ï¼šå‘èµ·å¤–ç½‘è¯·æ±‚' },
            { line: 25, text: '// ğŸ’¡ ç†”æ–­è¢«è§¦å‘åï¼ŒSpring è‡ªåŠ¨èµ°è¿™å¥—é€ƒç”Ÿå‡ºå£é€»è¾‘' },
            { line: 28, text: '// ğŸ’¡ Fallback æœåŠ¡é™çº§ï¼šä¸¢è½¦ä¿å¸…ä¿è¯æ ¸å¿ƒç³»ç»Ÿå¯ç”¨' },
        ],
        diagramMarkup: `sequenceDiagram\n    participant App as æ‰‹æœºå‰ç«¯\n    participant SBC as Spring æ–­è·¯å™¨\n    participant CDN as ç¬¬ä¸‰æ–¹ CDN\n    \n    Note over SBC: çŠ¶æ€ï¼šCLOSED (é—­åˆæ”¾è¡Œ)\n    App->>SBC: è·å–æ’­æ”¾åœ°å€\n    SBC->>CDN: GET /api/resolve\n    CDN--xSBC: 504 Gateway Timeout\n    \n    Note over SBC: è¿ç»­å¤±è´¥ 5 æ¬¡ï¼ŒçŠ¶æ€å˜ä¸º OPEN (ç†”æ–­)\n    App->>SBC: æ–°è€ç”¨æˆ·å†æ¬¡è¯·æ±‚è·å–åœ°å€\n    SBC-->>App: ç›´æ¥è¿”å› backup-play.mp4 (æ‹¦æˆªè°ƒç”¨è¿œç«¯)\n    Note right of SBC: çº¿ç¨‹ä¸æ‹¥å µï¼Œåç«¯å­˜æ´»`,
    },
    {
        id: 'be-5-1', type: 'backend',
        title: 'è¯¾ç¨‹ 5.1ï¼šMicrometer ä¸å…¨ç«™æ€§èƒ½å¤§ç›˜',
        category: 'æ¨¡å—5ï¼šSaaS å¯è§‚æµ‹æ€§åŸºå»º', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 5, lessonNumber: 1, language: 'java',
        startingCode: '',
        instructions: `# å¼•å…¥å¯è§‚æµ‹æ€§å¤§ç›˜ï¼šMicrometer\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nå½“æˆ‘ä»¬ä¸Šçº¿äº†è§†é¢‘ feed æµå’Œç‚¹èµåŠŸèƒ½åï¼Œé»‘å®¢å¯èƒ½åœ¨æ¶æ„åˆ·æ¥å£ï¼Œæˆ–è€…ç³»ç»Ÿååé‡æ­£åœ¨ä¸‹é™ï¼Œä½†ç”±äºæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œä½ åœ¨åå°å®Œå…¨ä¸çŸ¥æƒ…ã€‚æˆ‘ä»¬åˆ©ç”¨ Spring Boot Actuator ä¸ Micrometer å°† API çš„å„é¡¹æŒ‡æ ‡æš´éœ²å‡ºå»ï¼Œä»è€Œç”¨ Grafana æ„å»ºæˆ‘ä»¬è‡ªå·±çš„ç›‘æ§ä»ªè¡¨ã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- \`@Timed\` æœé›†æ–¹æ³•è€—æ—¶ä¸è°ƒç”¨é‡ã€‚\n- \`Counter\` ä¸ \`Timer\` è‡ªå®šä¹‰åŸ‹ç‚¹ã€‚`,
        targetCode: `package com.codeforge.metrics;\n\nimport io.micrometer.core.annotation.Timed;\nimport io.micrometer.core.instrument.Counter;\nimport io.micrometer.core.instrument.MeterRegistry;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class AnalyticsMetricsController {\n\n    // ğŸ’¡ åœ¨ä¼ä¸šé‡Œï¼Œè¿™å°±æ˜¯æ‰“ç‚¹çš„çµé­‚ç±»\n    private final Counter maliciousAttemptCounter;\n\n    // ğŸ’¡ æ„é€ å™¨æ³¨å…¥æ³¨å†Œè¡¨ï¼Œè¿™å°†è¢« Prometheus æ¯ç§’æ‹‰å–ä¸€æ¬¡\n    public AnalyticsMetricsController(MeterRegistry registry) {\n        this.maliciousAttemptCounter = Counter.builder("security.malicious.attempts")\n            .description("è®°å½•æ‰€æœ‰ç–‘ä¼¼æœºå™¨äººæ“ä½œçš„å±é™©è¡Œä¸º")\n            .tags("environment", "production", "region", "ap-east")\n            .register(registry);\n    }\n\n    // ğŸ’¡ @Timed ä¸ç”¨å†™ä»»ä½•ä»£ç ï¼Œè‡ªåŠ¨æŠŠæ­¤ HTTP æ¥å£çš„ p99ã€p95 è€—æ—¶å’Œæ€» QPS å½•å…¥ä»ªè¡¨æ¿\n    @Timed(value = "api.video.upload.time", description = "ä¸Šä¼ è§†é¢‘è€—æ—¶åˆ†å¸ƒ")\n    @PostMapping("/api/videos/upload")\n    public String uploadVideo(String payload) {\n        \n        if (payload.contains("<script>")) {\n            // ğŸ’¡ ä¸šåŠ¡åŸ‹ç‚¹ï¼šä¸€æ—¦æœ‰æ”»å‡»å°è¯•ï¼Œæˆ‘ä»¬è®©é›·è¾¾è­¦æŠ¥ +1\n            maliciousAttemptCounter.increment();\n            throw new IllegalArgumentException("XSS æ”»å‡»é˜»æ–­");\n        }\n        \n        return "è§†é¢‘è§£ææˆåŠŸï¼";\n    }\n}\n`,
        comments: [
            { line: 12, text: '// ğŸ’¡ Micrometer åŸå­è®¡æ•°å™¨' },
            { line: 17, text: '// ğŸ’¡ builder æ¨¡å¼ï¼Œå®šä¹‰ç›‘æ§æŒ‡æ ‡é¡¹çš„åå­—ï¼Œæ‰“ä¸Šç¯å¢ƒé«˜ç»´åº¦ Tags' },
            { line: 23, text: '// ğŸ’¡ Spring AOP æ³¨å…¥çš„éä¾µå…¥å¼æµ‹é‡' },
            { line: 29, text: '// ğŸ’¡ æä½å¼€é”€çš„å†…å­˜ç´¯åŠ ï¼ŒæŠ¥è­¦å™¨ä¼šåœ¨ Grafana å¼¹å‡ºé¡µè‡ªåŠ¨é—ªçƒ' },
        ],
    },
    {
        id: 'be-6-1', type: 'backend',
        title: 'è¯¾ç¨‹ 6.1ï¼šDocker å®¹å™¨åŒ–ä½ çš„ SaaS API',
        category: 'æ¨¡å—6ï¼šå®¹å™¨è°ƒåº¦ä¸é›†ç¾¤ K8s', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 6, lessonNumber: 1, language: 'dockerfile',
        startingCode: '',
        instructions: `# ä½¿ç”¨ Docker å®¹å™¨åˆ†å‘ SaaS åº”ç”¨\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nåç«¯ä»£ç å¦‚æœåªåœ¨ä½ è‡ªå·±çš„ç”µè„‘ä¸Šèƒ½è·‘ï¼Œé‚£å°±ä¸æ˜¯çœŸæ­£çš„ç”Ÿäº§çº§å·¥ç¨‹ï¼ˆ"But it works on my machine!"ï¼‰ã€‚ä¸ºäº†è®©å›¢é˜Ÿæ–°æ¢ç”µè„‘çš„å°ä¼™ä¼´ä¸€é”®æ‹‰èµ·åç«¯ï¼Œä¹Ÿä¸ºäº†èƒ½å‘å¸ƒåˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ \`Dockerfile\`ã€‚\næˆ‘ä»¬å°†ä½¿ç”¨**å¤šé˜¶æ®µæ„å»ºï¼ˆMulti-stage Buildï¼‰**ï¼Œåœ¨ Docker å†…éƒ¨è·‘ Gradle ç¼–è¯‘æºä»£ç ï¼Œä»¥ç¡®ä¿å¾—åˆ°æå°ä½“ç§¯çš„ç”Ÿäº§é•œåƒã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- æŒæ¡åŸºç¡€çš„ Dockerfile æŒ‡ä»¤ï¼šFROM, COPY, RUN, ENTRYPOINTã€‚\n- ä½¿ç”¨å¤šç«¯éš”ç¦»å±è”½å®¿ä¸»æœºç¯å¢ƒå·®å¼‚ã€‚`,
        targetCode: `# ğŸ’¡ ç¬¬ä¸€é˜¶æ®µï¼šåˆ©ç”¨å¸¦æœ‰ Gradle ä¸ JDK 21 çš„åºå¤§ç¯å¢ƒå»ã€ç¼–è¯‘ã€‘æºç \nFROM eclipse-temurin:21-jdk-alpine AS builder\nWORKDIR /app\n# ğŸ’¡ åªæ‹·è´ä¾èµ–æè¿°æ–‡ä»¶ï¼Œå¦‚æœæœªå˜æ›´ï¼Œè¿™ä¸€å±‚çš„ç¼“å­˜ä¸é‡å»ºï¼Œé€Ÿåº¦æå¿«ï¼\nCOPY gradlew .\nCOPY gradle gradle\nCOPY build.gradle settings.gradle ./\n\n# ğŸ’¡ æ‹·è´å…·ä½“ä¸šåŠ¡ï¼Œå¹¶ä¸”ç”¨ Gradle æ‰“ä¸‹å«æœ‰å‡ åMBçš„ jar åŒ…\nCOPY src src\nRUN ./gradlew bootJar --no-daemon\n\n\n# ğŸ’¡ ç¬¬äºŒé˜¶æ®µï¼šä¸¢å¼ƒä¸Šæ–¹ä½“ç§¯åºå¤§çš„ builder é˜¶æ®µ\n# æˆ‘ä»¬åªæƒ³è¦ä¸€ä¸ªè£…æœ‰å¾®ç¼©ç‰ˆ JRE (Java è¿è¡Œæ—¶) çš„è½»é‡å¹²å‡€ç¯å¢ƒ\nFROM eclipse-temurin:21-jre-alpine AS production\nWORKDIR /app\n# ğŸ’¡ -Xmx512m æå…¶é‡è¦ï¼Œé™åˆ¶å®¹å™¨å†…å­˜å ç”¨ä»¥é˜²è¢« OOM Killer æ€æ‰\nENV JAVA_OPTS="-Xms256m -Xmx512m"\n\n# ğŸ’¡ \`--from=builder\`ï¼Œè·¨é˜¶æ®µå·å–é‚£ä¸ªçƒ­è…¾è…¾çš„ jar åŒ…\nCOPY --from=builder /app/build/libs/*.jar app.jar\n\n# ğŸ’¡ æš´éœ²æœ¬å®¹å™¨é»˜è®¤æ‹¥æŠ±çš„ç«¯å£\nEXPOSE 8080\n\n# ğŸ’¡ ä½œä¸ºå®¹å™¨å¯åŠ¨ä¸»è¿›ç¨‹ï¼Œè¿›ç¨‹ä¸æ­»å®¹å™¨ä¸é€€\nENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]\n`,
        comments: [
            { line: 2, text: '# ğŸ’¡ è‚¥å¤§çš„åº•åº§ï¼šæ„å»ºä¸“ç”¨ï¼Œå†…å« JDK ç¼–è¯‘å™¨' },
            { line: 15, text: '# ğŸ’¡ å‰Šç˜¦çš„åº•åº§ï¼šç”Ÿäº§æœå½¹ä¸“ç”¨ï¼Œåªå‰© JREï¼Œé•œåƒä½“ç§¯å¯é™è‡³ 1/4ï¼' },
            { line: 21, text: '# ğŸ’¡ è¿™æ˜¯åˆ†é˜¶æ®µæ‰“åŒ…æ¶æ„çš„ç²¾é«“' },
            { line: 27, text: '# ğŸ’¡ exec æ¨¡å¼æ›¿æ¢ 1 å·è¿›ç¨‹ï¼Œä¼˜é›…æ¥æ”¶åœæ­¢ä¿¡å· (SIGTERM)' },
        ],
    },
    {
        id: 'be-6-2', type: 'backend',
        title: 'è¯¾ç¨‹ 6.2ï¼šDocker Compose ç½‘ç»œæ¶æ„æ‹“æ‰‘',
        category: 'æ¨¡å—6ï¼šå®¹å™¨è°ƒåº¦ä¸é›†ç¾¤ K8s', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 6, lessonNumber: 2, language: 'yaml',
        startingCode: '',
        instructions: `# åŸºç¡€è®¾æ–½å³ä»£ç  (IaC)\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€å † SaaS ç»„ä»¶ï¼šSpring Boot API å®¹å™¨ï¼ŒMySQL å®¹å™¨ï¼ŒRedis å®¹å™¨ï¼Œè¿˜æœ‰ä¸€ä¸ªä¸ºäº†ååè€Œé…çš„ Kafkaã€‚\nå¦‚æœç”¨æ‰‹æ•²å‘½ä»¤ \`docker run\` ä¸€ä¸ªä¸ªå¼•èµ·æ¥ï¼Œéå¸¸å®¹æ˜“å¿˜è®°å‚æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨ \`docker-compose.yml\` å°†è¿™ä¸ªé¡¹ç›®çš„å‘½è¿è¿›è¡Œå£°æ˜å¼æ†ç»‘ï¼Œä¸€é”® \`up -d\` å¬å”¤æ•´ä¸ªå¾®æœåŠ¡ç¾¤è½ã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- å®šä¹‰å¾®æœåŠ¡æ¶æ„ä¾èµ–ï¼ˆ\`depends_on\`ï¼‰ã€‚\n- æš´éœ²å®¹å™¨ç½‘ç»œï¼ˆHost Ports å¯¹é˜µ Container Portsï¼‰ã€‚`,
        targetCode: `version: '3.8'\n\n# ğŸ’¡ å®šä¹‰åœ¨åŒä¸€ä¸ª docker-compose æ–‡ä»¶ä¸­çš„æ‰€æœ‰å…„å¼Ÿå®¹å™¨ï¼Œå¤©ç”Ÿå±äºåŒä¸€ä¸ªå†…éƒ¨æ¡¥æ¥ç½‘ç»œ\nservices:\n  # æˆ‘ä»¬çš„ SaaS åç«¯åº”ç”¨\n  api:\n    build: .\n    # ğŸ’¡ æš´éœ²åˆ°å®¿ä¸»æœºçš„ç«¯å£ï¼ˆä¾›å‰ç«¯ React çš„ Vite ä»£ç†å»è¿æ¥ï¼‰\n    ports:\n      - "8080:8080"\n    environment:\n      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/video_saas_db\n      - SPRING_REDIS_HOST=redis\n      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092\n    depends_on:\n      mysql: \n        condition: service_healthy\n      redis:\n        condition: service_started\n\n  mysql:\n    image: mysql:8.0\n    # ğŸ’¡ ä¸å¯¹å¤–(å®¿ä¸»æœºç”µè„‘)æŠ›å‡º 3306ï¼Œæå¤§åŠ å¼ºå®‰å…¨ï¼›API å®¹å™¨å†…ç½‘é€šè¿‡æœåŠ¡å"mysql"ä¾ç„¶è¿å¾—ä¸Šï¼\n    environment:\n      - MYSQL_ROOT_PASSWORD=highly_secured_pWd!\n      - MYSQL_DATABASE=video_saas_db\n    healthcheck:\n      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]\n      timeout: 20s\n      retries: 5\n\n  redis:\n    image: redis:alpine\n    # åŒæ ·å°†å…¶é›ªè—åœ¨å†…éƒ¨è™šæ‹Ÿç½‘ç»œæ·±å¤„\n\n  # ... Zookeeper & Kafka çœç•¥\n`,
        comments: [
            { line: 12, text: '# ğŸ’¡ å‘ç°äº†å—ï¼Ÿè¿æ¥å…¨ç”¨çš„æ˜¯å¯¹æ–¹çš„æœåŠ¡å(æ¯”å¦‚ //mysql:3306)ï¼Œè¿™å« DNS å†…ç½‘æœåŠ¡å‘ç°' },
            { line: 16, text: '# ğŸ’¡ è¿™æ˜¯å¯åŠ¨å¤§ç®¡å®¶ï¼šç¡®ä¿æ•°æ®åº“å®Œæˆç¡¬æ±‰æ¢é’ˆå­˜æ´»æ£€æµ‹åï¼Œå†å”¤é†’ Spring ç»„ä»¶ï¼Œå…å¾—æŠ›è¿æ¥å¤±è´¥æ—¥å¿—' },
            { line: 23, text: '# ğŸ’¡ å¦‚æœä½ åœ¨ä¸‹é¢å†™ ports 3306 å°±ä¼šæŠŠé—¨é¢å¯¹å…¨ç½‘é»‘å®¢æ•å¼€' },
        ],
        diagramMarkup: `flowchart TD\n    subgraph ä½ çš„å°å¼æœº (Host Machine)\n        subgraph Docker Bridge å†…ç½‘ (éš”ç¦»)\n            API[SaaS Spring Boot API (8080)]\n            MySQL[(MySQL (3306 éšè—))]\n            Redis[(Redis (6379 éšè—))]\n            Kafka{Kafka (9092 éšè—)}\n            \n            API -->|å†…ç½‘æœåŠ¡å:3306| MySQL\n            API -->|å†…ç½‘æœåŠ¡å:6379| Redis\n            API -->|å†…ç½‘æœåŠ¡å:9092| Kafka\n        end\n        \n        Vite[å‰ç«¯ React Vite Server (5173)]\n        Vite -->|åå‘ä»£ç† fetch| API\n    end\n    \n    style MySQL fill:#f9f,stroke:#333\n    style Redis fill:#f9f,stroke:#333\n    style Kafka fill:#f9f,stroke:#333\n    style API fill:#bbf,stroke:#333`,
    },
    {
        id: 'be-6-3', type: 'backend',
        title: 'è¯¾ç¨‹ 6.3ï¼šK8s æ¨ªå‘æ‰©å±•ä¸äº‘åŸç”Ÿå£°æ˜',
        category: 'æ¨¡å—6ï¼šå®¹å™¨è°ƒåº¦ä¸é›†ç¾¤ K8s', track: 'åç«¯å·¥ç¨‹',
        moduleNumber: 6, lessonNumber: 3, language: 'yaml',
        startingCode: '',
        instructions: `# Kubernetes: äº‘åŸç”Ÿæ˜Ÿæµ·çš„æŒèˆµäºº\n\n## ä¸šåŠ¡ä¸Šä¸‹æ–‡\nå½“ç½‘ç«™è¿æ¥æ˜¥èŠ‚çº¢åŒ…ç­‰é«˜å¹¶å‘å³°å€¼æ—¶ï¼Œ1ä¸ª Docker è‚¯å®šæ‰›ä¸ä½ã€‚Kubernetes (K8s) æ˜¯è‡ªåŠ¨åŒ–å®¹å™¨è¿ç»´çš„ç¥å…µï¼šå¦‚æœè¿™å°æœåŠ¡å™¨ç‚¸äº†ï¼Œå®ƒä¼šæŠŠå®¹å™¨é£˜ç§»åˆ°åˆ«äººå®¶æœåŠ¡å™¨ï¼›å¦‚æœ CPU è¶…è¿‡äº† 80%ï¼Œå®ƒä¼šè‡ªåŠ¨å¢å‡å®¹å™¨æ•°é‡â€”â€”Horizontal Pod Autoscaler (HPA)ã€‚\n\n## å­¦ä¹ ç›®æ ‡\n- ç¼–å†™ Deployment \`yaml\`ã€‚\n- æŒæ¡ K8s Replicas ä¸ Service çš„æ˜ å°„å“²å­¦ã€‚`,
        targetCode: `apiVersion: apps/v1\n# ğŸ’¡ Deployment å‰§æœ¬ï¼šæŒç®¡ Podï¼ˆå®¹å™¨å°åˆ†é˜Ÿï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€æ»šåŠ¨æ›´æ–° (Rolling Update)\nkind: Deployment\nmetadata:\n  name: video-saas-deployment\nspec:\n  # ğŸ’¡ K8s å¬ä»è°ƒé£ï¼Œä¼šæ— è§†å¤©ä¸‹å¤§ä¹±åœ°å¼ºè¡Œä¿æŒæœåŠ¡å™¨å†…æ—¶åˆ»æœ‰ 3 ä»½å…‹éš†ä½“å‰¯æœ¬æ´»ç€\n  replicas: 3\n  selector:\n    matchLabels:\n      app: video-saas-api\n  template:\n    metadata:\n      labels:\n        app: video-saas-api\n    spec:\n      containers:\n        - name: sprint-boot-api\n          image: codeforge/video-saas-api:latest\n          resources:\n            # ğŸ’¡ HPA (è‡ªåŠ¨æ‰©å®¹) çš„ä¾å‡­ï¼šæŒ‡æ˜å®¹å™¨æœ€å¤šæœ€å°‘åƒå¤šå°‘å†…å­˜/CPU\n            requests:\n              cpu: "500m"\n              memory: "512Mi"\n            limits:\n              cpu: "1000m"\n              memory: "1Gi"\n          ports:\n            - containerPort: 8080\n\n---\napiVersion: v1\n# ğŸ’¡ Service ä¸­ä»‹è€…ï¼šå› ä¸ºé‚£ 3 ä¸ªå‰¯æœ¬å¯èƒ½å› ä¸ºå®•æœºç»å¸¸æ¢ IPï¼Œç”¨ä¸­è½¬ç«™ç»™ä»–ä»¬ä¸ªç¨³å®šçš„é—¨ç‰Œå·å¯¹å¤–ç»Ÿä¸€æ¥å®¢\nkind: Service\nmetadata:\n  name: video-saas-service\nspec:\n  type: ClusterIP\n  selector:\n    # ğŸ’¡ çµé­‚åŒ¹é…ï¼šæ ¹æ®ä¸Šé¢å†™çš„ labelï¼Œå¼ºè¡Œæ¡†èµ°é‚£ 3 ä¸ªé£˜å¿½ä¸å®šçš„å‰¯æœ¬\n    app: video-saas-api\n  ports:\n    - protocol: TCP\n      port: 80\n      # ğŸ’¡ æµé‡æŠµè¾¾è¿™æ‰‡é—¨ 80 åï¼ŒK8s çš„ç½‘ç»œæ ˆè‡ªåŠ¨å°†è¯·æ±‚è½®å·¡ï¼ˆè´Ÿè½½å‡è¡¡ Load Balanceï¼‰ç»™èƒŒåå‰¯æœ¬çš„ 8080\n      targetPort: 8080\n`,
        comments: [
            { line: 2, text: '# ğŸ’¡ K8s å¹¶ä¸æ˜¯ç›´æ¥é©±åŠ¨ Dockerï¼Œè€Œæ˜¯ä»¥ Pod ä¸ºæœ€å°ç®¡ç†èˆªæ¯' },
            { line: 8, text: '# ğŸ’¡ å£°æ˜å¼é«˜å¯ç”¨ï¼šå°‘ä¸€ä¸ªè¡¥ä¸€ä¸ªï¼Œæ­»ä¸€ä¸ªé‡å¯ä¸€ä¸ª' },
            { line: 34, text: '# ğŸ’¡ K8s æœ€ç²¾å¦™ç»ä¼¦çš„è®¾è®¡â€”â€”å†…éƒ¨è§£è€¦çš„è´Ÿè½½å‡è¡¡å™¨' },
        ],
    },
];
