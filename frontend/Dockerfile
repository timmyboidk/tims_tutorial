# ğŸ’¡ é˜¶æ®µ 1ï¼šæ„å»ºé˜¶æ®µ (builder)
# ä½¿ç”¨å¸¦æœ‰ Node ç¯å¢ƒçš„å®˜æ–¹é•œåƒæ¥æ‰“åŒ… React é¡¹ç›®
FROM node:20-alpine AS builder

# ğŸ’¡ è®¾å®šå·¥ä½œç›®å½•
WORKDIR /app

# ğŸ’¡ åªæ‹·è´ä¾èµ–æè¿°æ–‡ä»¶ï¼Œå®‰è£…ä¾èµ–ï¼ˆå–„ç”¨ Docker ç¼“å­˜å±‚æœºåˆ¶ï¼Œå¦‚æœ package.json æ²¡å˜åˆ™æé€Ÿè·³è¿‡è¿™ä¸€æ­¥ï¼‰
COPY package.json package-lock.json ./
RUN npm install

# ğŸ’¡ å°†ä¸šåŠ¡ä»£ç å…¨é‡æ‹·è´è¿›å»ï¼Œè¿›è¡Œæ„å»º
COPY . .
RUN npm run build

# =========================================================

# ğŸ’¡ é˜¶æ®µ 2ï¼šç”Ÿäº§æœåŠ¡é˜¶æ®µ (production)
# ä½¿ç”¨æå°ä½“ç§¯çš„ Node alpine æœåŠ¡ï¼Œä¸ä»…æ‰˜ç®¡æ‰“åŒ…å‡ºæ¥çš„é™æ€æ–‡ä»¶ï¼Œè¿˜å†…ç½® Express API è·¯ç”±æ¥å®ç°æŒä¹…åŒ–åŠŸèƒ½ï¼
FROM node:20-alpine

WORKDIR /app

# ä» builder æ‹·è´æ„å»ºå¥½çš„å®Œå…¨é™æ€é¡µé¢
COPY --from=builder /app/dist ./dist
# æ‹·è´ Express çš„æ ¸å¿ƒæ”¯æ’‘æ–‡ä»¶å’Œä¾èµ–
COPY package.json package-lock.json ./
RUN npm install --production

# æ‹·è´åç«¯ä»£ç å±‚
COPY server.js ./
COPY api ./api

# (ç”±äºå–æ¶ˆäº† Nginxï¼Œéœ€è¦ç§»é™¤ nginx.conf çš„ç›¸å…³æ‹·è´)

# ğŸ’¡ æš´éœ² 80 ç«¯å£ç»™å¤–éƒ¨æ˜ å°„ï¼ˆæ³¨æ„ server.js é»˜è®¤ç›‘å¬ 80ï¼‰
EXPOSE 80

# ğŸ’¡ å¯åŠ¨ Express æœåŠ¡
CMD ["node", "server.js"]
