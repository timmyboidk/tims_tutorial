version: '3.8'

services:
  # ==============================
  # ğŸ’¡ 1. æ ¸å¿ƒåº”ç”¨å±‚ (Application)
  # ==============================

  # 1.1 å‰ç«¯ï¼šçŸ­è§†é¢‘ SaaS React çœ‹æ¿
  frontend:
    build: ./frontend
    ports:
      - "5173:80" # å°†ä¸»æœºçš„ 5173 è·¯ç”±åˆ° Nginx/Express çš„ 80
    environment:
      - MONGO_URI=mongodb://mongo:27017/progress_db
    depends_on:
      - api
      - mongo
    networks:
      - saas-network

  # 1.2 åç«¯ï¼šSpring Boot API æ ¸å¿ƒå¼•æ“
  api:
    build: ./backend
    # ports:
    # - "8080:8080" # ğŸ’¡ å¼ºçƒˆå»ºè®®ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒAPI é€šå¸¸ä¸ç›´æ¥å¯¹å…¬ç½‘æš´éœ² 8080ï¼Œè€Œæ˜¯é€šè¿‡å‰ç«¯ Nginx çš„ /api åå‘ä»£ç†è¿›å†…ç½‘ï¼å¦‚æœéœ€è¦åœ¨å®¿ä¸»æœºè°ƒè¯•åˆ™å–æ¶ˆæ³¨é‡Šã€‚
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/video_saas_db
      - SPRING_REDIS_HOST=redis
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
      kafka:
        condition: service_started
    networks:
      - saas-network

  # ==============================
  # ğŸ’¡ 2. æ•°æ®ä¸ä¸­é—´ä»¶å±‚ (Infrastructure)
  # ==============================

  # 2.1 å…³ç³»å‹æ•°æ®åº“ MySQL (å®˜æ–¹æ”¯æŒ ARM64)
  mysql:
    image: mysql:8.0
    # ports:
    #  - "3306:3306" # ğŸ’¡ ç»ä¸å…è®¸å¯¹å…¬ç½‘æš´éœ² 3306 ç«¯å£ï¼Œåªå…è®¸ Docker å†…ç½‘çš„æœåŠ¡ï¼ˆå¦‚ APIï¼‰è¿›è¡Œè®¿é—®ï¼
    environment:
      - MYSQL_ROOT_PASSWORD=saas_root_pwd
      - MYSQL_DATABASE=video_saas_db
      - MYSQL_USER=saas_user
      - MYSQL_PASSWORD=saas_pwd
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      timeout: 20s
      retries: 5
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - saas-network

  # 2.2 è¯¾ç¨‹è¿›åº¦æ•°æ®åº“ MongoDB (å®˜æ–¹æ”¯æŒ ARM64)
  mongo:
    image: mongo:7.0
    volumes:
      - mongo-data:/data/db
    networks:
      - saas-network

  # 2.3 å†…å­˜ç¼“å­˜ Redis (åŠ é€Ÿå­—å…¸æŸ¥è¯¢ä¸çƒ­é—¨è§†é¢‘)
  redis:
    image: redis:alpine
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - saas-network

  # 2.4 åˆ†å¸ƒå¼æµå¤„ç†å¹³å° (ä½¿ç”¨å®˜æ–¹ Apache ç‰ˆ Zookeeper + Kafka)
  zookeeper:
    image: zookeeper:latest
    networks:
      - saas-network

  kafka:
    image: apache/kafka:latest
    depends_on:
      - zookeeper
    environment:
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
    networks:
      - saas-network

# ğŸ’¡ å®šä¹‰å…·åæŒä¹…åŒ–å·ï¼Œä¿è¯æ•°æ®åº“é‡å¯ä¸ä¸¢æ•°æ®
volumes:
  mysql-data:
  redis-data:
  mongo-data:

    # ğŸ’¡ å£°æ˜æ•´ä¸ªç³»ç»Ÿæ‰€åœ¨çš„ç§æœ‰ç½‘æ®µ
networks:
  saas-network:
    driver: bridge
